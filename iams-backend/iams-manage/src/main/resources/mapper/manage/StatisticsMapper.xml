<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iams.manage.mapper.StatisticsMapper">

    <resultMap type="Statistics" id="StatisticsResult">
        <result property="id"    column="id"    />
        <result property="statDate"    column="stat_date"    />
        <result property="totalBorrows"    column="total_borrows"    />
        <result property="totalReturns"    column="total_returns"    />
        <result property="totalLoans"    column="total_loans"    />
        <result property="totalLost"    column="total_lost"    />
        <result property="archivedCount"    column="archived_count"    />
        <result property="pendingCount"    column="pending_count"    />
        <result property="electronicCount"    column="electronic_count"    />
        <result property="physicalCount"    column="physical_count"    />
        <result property="activeUserList"    column="active_user_list"    />
        <result property="createdAt"    column="created_at"    />
        <result property="cabinetCount"    column="cabinet_count"    />
        <result property="repositoryCount"    column="repository_count"    />
        <result property="seriesData"    column="series_data"    />
    </resultMap>

    <!-- 为TbStatistics类添加专用的ResultMap -->
    <resultMap type="com.iams.manage.domain.TbStatistics" id="TbStatisticsResult">
        <result property="id"    column="id"    />
        <result property="statDate"    column="stat_date"    />
        <result property="totalBorrows"    column="total_borrows"    />
        <result property="totalReturns"    column="total_returns"    />
        <result property="totalLoans"    column="total_loans"    />
        <result property="totalLost"    column="total_lost"    />
        <result property="archivedCount"    column="archived_count"    />
        <result property="pendingCount"    column="pending_count"    />
        <result property="electronicCount"    column="electronic_count"    />
        <result property="physicalCount"    column="physical_count"    />
        <result property="activeUserList"    column="active_user_list"    />
        <result property="createdAt"    column="created_at"    />
        <result property="cabinetCount"    column="cabinet_count"    />
        <result property="repositoryCount"    column="repository_count"    />
        <result property="seriesData"    column="series_data"    />
    </resultMap>

    <sql id="selectStatisticsVo">
        select id, stat_date, total_borrows, total_returns, total_loans, total_lost, archived_count, pending_count, electronic_count, physical_count, active_user_list, created_at, cabinet_count, repository_count, series_data from tb_statistics
    </sql>

    <select id="selectStatisticsList" parameterType="Statistics" resultMap="StatisticsResult">
        <include refid="selectStatisticsVo"/>
        <where>
            <if test="statDate != null "> and stat_date = #{statDate}</if>
            <if test="totalBorrows != null "> and total_borrows = #{totalBorrows}</if>
            <if test="totalReturns != null "> and total_returns = #{totalReturns}</if>
            <if test="totalLoans != null "> and total_loans = #{totalLoans}</if>
            <if test="totalLost != null "> and total_lost = #{totalLost}</if>
            <if test="archivedCount != null "> and archived_count = #{archivedCount}</if>
            <if test="pendingCount != null "> and pending_count = #{pendingCount}</if>
            <if test="electronicCount != null "> and electronic_count = #{electronicCount}</if>
            <if test="physicalCount != null "> and physical_count = #{physicalCount}</if>
            <if test="activeUserList != null  and activeUserList != ''"> and active_user_list like concat('%', CAST(#{activeUserList} AS json), '%')</if>
            <if test="createdAt != null "> and created_at = #{createdAt}</if>
            <if test="cabinetCount != null "> and cabinet_count = #{cabinetCount}</if>
            <if test="repositoryCount != null "> and repository_count = #{repositoryCount}</if>
            <if test="seriesData != null  and seriesData != ''"> and series_data like concat('%', #{seriesData}, '%')</if>
        </where>
    </select>

    <select id="selectStatisticsById" parameterType="Long" resultMap="StatisticsResult">
        <include refid="selectStatisticsVo"/>
        where id = #{id}
    </select>

    <insert id="insertStatistics" parameterType="Statistics" useGeneratedKeys="true" keyProperty="id">
        insert into tb_statistics
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="statDate != null">stat_date,</if>
            <if test="totalBorrows != null">total_borrows,</if>
            <if test="totalReturns != null">total_returns,</if>
            <if test="totalLoans != null">total_loans,</if>
            <if test="totalLost != null">total_lost,</if>
            <if test="archivedCount != null">archived_count,</if>
            <if test="pendingCount != null">pending_count,</if>
            <if test="electronicCount != null">electronic_count,</if>
            <if test="physicalCount != null">physical_count,</if>
            <if test="activeUserList != null and activeUserList != ''">active_user_list,</if>
            <if test="createdAt != null">created_at,</if>
            <if test="cabinetCount != null">cabinet_count,</if>
            <if test="repositoryCount != null">repository_count,</if>
            <if test="seriesData != null and seriesData != ''">series_data,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="statDate != null">#{statDate},</if>
            <if test="totalBorrows != null">#{totalBorrows},</if>
            <if test="totalReturns != null">#{totalReturns},</if>
            <if test="totalLoans != null">#{totalLoans},</if>
            <if test="totalLost != null">#{totalLost},</if>
            <if test="archivedCount != null">#{archivedCount},</if>
            <if test="pendingCount != null">#{pendingCount},</if>
            <if test="electronicCount != null">#{electronicCount},</if>
            <if test="physicalCount != null">#{physicalCount},</if>
            <if test="activeUserList != null and activeUserList != ''">CAST(#{activeUserList} AS json),</if>
            <if test="createdAt != null">#{createdAt},</if>
            <if test="cabinetCount != null">#{cabinetCount},</if>
            <if test="repositoryCount != null">#{repositoryCount},</if>
            <if test="seriesData != null and seriesData != ''">#{seriesData},</if>
        </trim>
    </insert>

    <update id="updateStatistics" parameterType="Statistics">
        update tb_statistics
        <trim prefix="SET" suffixOverrides=",">
            <if test="statDate != null">stat_date = #{statDate},</if>
            <if test="totalBorrows != null">total_borrows = #{totalBorrows},</if>
            <if test="totalReturns != null">total_returns = #{totalReturns},</if>
            <if test="totalLoans != null">total_loans = #{totalLoans},</if>
            <if test="totalLost != null">total_lost = #{totalLost},</if>
            <if test="archivedCount != null">archived_count = #{archivedCount},</if>
            <if test="pendingCount != null">pending_count = #{pendingCount},</if>
            <if test="electronicCount != null">electronic_count = #{electronicCount},</if>
            <if test="physicalCount != null">physical_count = #{physicalCount},</if>
            <if test="activeUserList != null and activeUserList != ''">active_user_list = CAST(#{activeUserList} AS json),</if>
            <if test="createdAt != null">created_at = #{createdAt},</if>
            <if test="cabinetCount != null">cabinet_count = #{cabinetCount},</if>
            <if test="repositoryCount != null">repository_count = #{repositoryCount},</if>
            <if test="seriesData != null and seriesData != ''">series_data = #{seriesData},</if>
        </trim>
        where id = #{id}
    </update>

    <delete id="deleteStatisticsById" parameterType="Long">
        delete from tb_statistics where id = #{id}
    </delete>

    <delete id="deleteStatisticsByIds" parameterType="String">
        delete from tb_statistics where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <select id="selectMonthlyZeroHourStatistics" resultMap="TbStatisticsResult">
        SELECT *
        FROM tb_statistics
        WHERE CAST(EXTRACT(YEAR FROM created_at) AS INTEGER) = CAST(#{year} AS INTEGER)
          AND CAST(EXTRACT(MONTH FROM created_at) AS INTEGER) = CAST(#{month} AS INTEGER)
        ORDER BY stat_date, created_at
    </select>

    <select id="selectRecentZeroHourStatistics" resultMap="TbStatisticsResult">
        SELECT *
        FROM tb_statistics
        WHERE CAST(stat_date AS DATE) >= CAST(CURRENT_DATE - CAST(#{days} AS INTEGER) AS DATE)
          AND CAST(EXTRACT(HOUR FROM created_at) AS INTEGER) = CAST(0 AS INTEGER)
        ORDER BY stat_date DESC, created_at DESC
    </select>

    <select id="selectLatestStatistics" resultMap="TbStatisticsResult">
        SELECT *
        FROM tb_statistics
        ORDER BY created_at DESC
        LIMIT 1
    </select>

    <select id="selectHourlyStatistics" resultMap="TbStatisticsResult">
        SELECT *
        FROM tb_statistics
        WHERE CAST(stat_date AS DATE) = CAST(#{date} AS DATE)
        ORDER BY stat_date
    </select>
</mapper>